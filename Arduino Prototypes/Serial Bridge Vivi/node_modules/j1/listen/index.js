const console = require('../console').create('listen');

function listen(server, ...args) {
	return new Promise((resolve, reject) => {
		function onError(error) {
			switch (error && error.code) {
				case 'EADDRINUSE':
				case 'EACCES':
					if (error.port < 0xffff) {
						this.listen(error.port + 1);
						return;
					}
			}
			reject(error);
		}
		server
			.once('listening', function () {
				console.debug('listening: ' + this.address().port);
				this.removeListener('error', onError);
				resolve(this);
			})
			.on('error', onError)
			.listen(...args);
	});
}

module.exports = listen;
