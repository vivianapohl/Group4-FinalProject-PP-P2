const fs = require('fs');
const path = require('path');
const promisify = require('../promisify');
const stat = promisify(fs.stat, fs);
const mkdir = promisify(fs.mkdir, fs);
const DEFAULT_MODE = 0o777;

function mkdirp(dirPath, mode = DEFAULT_MODE) {
	return mkdir(dirPath, mode)
	.catch((error) => {
		switch (error.code) {
		case 'ENOENT':
			return mkdirp(path.dirname(dirPath), mode)
				.then(() => {
					return mkdirp(dirPath, mode);
				});
		case 'EEXIST':
			return stat(dirPath)
				.then((stats) => {
					if (stats.isDirectory()) {
						return;
					}
					throw error;
				});
		default:
			throw error;
		}
	})
	.then(() => {
		return dirPath;
	});
}

module.exports = mkdirp;
